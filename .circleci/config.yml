version: 2

default: &default
  docker:
    - image: regentmarkets/debian-ci:latest
      user: nobody
      auth:
        username: circle4regentmarkets
        password: $DOCKERHUB_PASSWORD
  working_directory: /home/git/regentmarkets/bom-rpc

alias:
  - &ssh_keys
    add_ssh_keys:
      fingerprints:
        - "26:72:b1:08:0f:c1:3b:2b:2d:ea:61:7d:d6:11:63:fb"
  - &git
    run:
      name: Update git repositories
      command: /opt/circle/prepare-test.sh
  - &services
    run:
      name: Start services
      command: |
        sudo mkdir -p /var/log/fixedodds
        sudo chown nobody:nogroup /var/log/fixedodds
        source /etc/profile.d/perl5.sh
        start_services
        touch /tmp/services.ready
      background: true
  - &wait_services
    run:
      name: Wait for services to start up
      command: |
        count=0
        while [ ! -f /tmp/services.ready ]; do
            echo 'Still waiting for services...'
            (( count++ )) && (( count >= 20 )) && break
            sleep 1
        done
  - &tests
    environment:
      PERL_TEST_HARNESS_DUMP_TAP: /var/tmp/test-output
      RPC_CONFIG: /home/git/regentmarkets/bom-rpc/rpc.conf.travis

jobs:
  syntax:
    <<: *default
    steps:
      - *ssh_keys
      - checkout
      - *git
      - *services
      - *wait_services
      - run:
          <<: *tests
          name: Verify syntax and compilation
          command: |
            echo '--formatter TAP::Formatter::JUnit' >> .proverc
            source /etc/profile.d/perl5.sh
            make syntax
      - store_test_results:
          path: /var/tmp/test-output
  unit:
    <<: *default
    steps:
      - *ssh_keys
      - checkout
      - *git
      - *services
      - *wait_services
      - run:
          <<: *tests
          name: Run tests
          command: |
            echo '--formatter TAP::Formatter::JUnit' >> .proverc
            source /etc/profile.d/perl5.sh
            make test
      - store_test_results:
          path: /var/tmp/test-output
  schema:
    <<: *default
    steps:
      - *ssh_keys
      - checkout
      - *git
      - *services
      - *wait_services
      - run:
          <<: *tests
          name: Run tests
          command: |
            echo '--formatter TAP::Formatter::JUnit' >> .proverc
            source /etc/profile.d/perl5.sh
            make json_schemas
      - store_test_results:
          path: /var/tmp/test-output

workflows:
  version: 2
  build-workflow:
    jobs:
      - syntax:
          context: perl
      - unit:
          context: perl
      - schema:
          context: perl

