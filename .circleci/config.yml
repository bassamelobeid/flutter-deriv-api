---
version: 2

default: &default
  resource_class: small
  docker:
  - image: regentmarkets/debian-ci:stable
    user: nobody
    auth:
      username: circle4regentmarkets
      password: $DOCKERHUB_PASSWORD
  shell: /bin/bash -leo pipefail
  working_directory: /home/git/regentmarkets/bom

alias:
- &ssh_keys
  add_ssh_keys:
    fingerprints:
    - 85:5e:13:f8:60:b2:55:a1:df:d1:8e:77:17:4c:3b:2d
- &update_git
  run:
    name: Update git repositories
    no_output_timeout: 3h
    command: /opt/circle/prepare-test.sh
- &services
  run:
    name: Start services
    command: |
      start_services
- &test_output
  environment:
    PERL_TEST_HARNESS_DUMP_TAP: /var/tmp/test-output

jobs:
  check_git_message:
    resource_class: small
    docker:
      - image: alpine/git:2.36.2
        entrypoint: /bin/sh
    steps:
    - checkout
    - run:
        no_output_timeout: 3h
        command: |
          if [[ -n "$CIRCLE_PULL_REQUEST" && $CIRCLE_BRANCH != "master" ]]; then
            GIT_COMMIT_DESC="$(git log --format=oneline -n 1 $CIRCLE_SHA1)";
            if echo $GIT_COMMIT_DESC | grep -E "\[\s*\bci\b.*]"; then exit 0; else echo "need tag [ci] to trigger tests"; exit 1; fi
          else
            echo "This is not a pull request, Branch: $CIRCLE_BRANCH"
            exit 0
          fi
        name: Check git message if it contains the keyword [ci]
  syntax_unit:
    <<: *default
    steps:
    - *ssh_keys
    - *update_git
    - run:
        <<: *test_output
        no_output_timeout: 3h
        command: |
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make syntax
        name: Code structure and syntax
    - run:
        no_output_timeout: 3h
        command: make unit
        name: unit tests
    - store_test_results:
        path: /var/tmp/test-output
  syntax_diff_unit:
    <<: *default
    steps:
    - *ssh_keys
    - *update_git
    - run:
        <<: *test_output
        no_output_timeout: 3h
        command: |
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make syntax_diff
        name: Code structure and syntax
    - run:
        no_output_timeout: 3h
        command: make unit
        name: unit tests
    - store_test_results:
        path: /var/tmp/test-output
  product_contract:
    <<: *default
    steps:
    - *ssh_keys
    - *update_git
    - *services
    - run:
        <<: *test_output
        name: Product contract test
        no_output_timeout: 3h
        command: |
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make unit_test_product_contract
    - store_test_results:
        path: /var/tmp/test-output
  validation:
    <<: *default
    steps:
    - *ssh_keys
    - *update_git
    - *services
    - run:
        <<: *test_output
        name: Validation
        no_output_timeout: 3h
        command: |
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make unit_test_validation
    - store_test_results:
        path: /var/tmp/test-output
  memory_test:
    <<: *default
    steps:
    - *ssh_keys
    - *update_git
    - *services
    - run:
        <<: *test_output
        name: MemoryTest
        no_output_timeout: 3h
        command: |
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make memory_test
    - store_test_results:
        path: /var/tmp/test-output
  pricing:
    <<: *default
    steps:
    - *ssh_keys
    - *update_git
    - *services
    - run:
        <<: *test_output
        name: Pricing
        no_output_timeout: 3h
        command: |
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make unit_test_pricing
    - store_test_results:
        path: /var/tmp/test-output
  product_others:
    <<: *default
    steps:
    - *ssh_keys
    - *update_git
    - *services
    - run:
        <<: *test_output
        name: Product extended
        no_output_timeout: 3h
        command: |
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make unit_test_product_contract_extended
    - run:
        name: Product base
        no_output_timeout: 3h
        command: make unit_test_product_base
        when: always
    - run:
        name: Product model
        no_output_timeout: 3h
        command: make unit_test_product_model
        when: always
    - run:
        name: Valatility
        no_output_timeout: 3h
        command: make unit_test_volatility
        when: always
    - run:
        name: Offerings
        no_output_timeout: 3h
        command: make unit_test_offerings
        when: always
    - store_test_results:
        path: /var/tmp/test-output
# bom repo changes frequently so it is important to check the below repo tests here
  benchmark_merlin_ovra:
    <<: *default
    steps:
    - *ssh_keys
    - *update_git
    - *services
    - run:
        <<: *test_output
        name: Merlin Benchmark
        no_output_timeout: 3h
        command: |
          cd /home/git/regentmarkets/bom-quant-benchmark
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make merlin_benchmark
    - run:
        <<: *test_output
        name: OVRA benchmark
        no_output_timeout: 3h
        command: |
          cd /home/git/regentmarkets/bom-quant-benchmark
          make OVRA_benchmark
        when: always
    - store_test_results:
        path: /var/tmp/test-output
  benchmark_SD:
    <<: *default
    working_directory: /home/git/regentmarkets/bom-quant-benchmark
    steps:
    - *ssh_keys
    - *update_git
    - *services
    - run:
        name: SDFX benchmark major
        no_output_timeout: 3h
        command: make SDFX_benchmark_major
        when: always
    - run:
        name: SDFX benchmark minor
        no_output_timeout: 3h
        command: make SDFX_benchmark_minor
        when: always
    - run:
        name: SDEQ benchmark OTC_DJI
        no_output_timeout: 3h
        command: make SDEQ_benchmark_OTC_DJI
        when: always
    - run:
        name: SDEQ benchmark OTC_FCHI
        no_output_timeout: 3h
        command: make SDEQ_benchmark_OTC_FCHI
        when: always
    - run:
        name: SDEQ benchmark OTC_SPC
        no_output_timeout: 3h
        command: make SDEQ_benchmark_OTC_SPC
        when: always
    - run:
        name: SDEQ benchmark SSECOMP
        no_output_timeout: 3h
        command: make SDEQ_benchmark_SSECOMP
        when: always
    - run:
        name: SDEQ benchmark OTC_FTSE
        no_output_timeout: 3h
        command: make SDEQ_benchmark_OTC_FTSE
        when: always
    - store_test_results:
        path: /var/tmp/test-output
  Pricing-Engine-Tests:
    <<: *default
    steps:
    - *ssh_keys
    - *update_git
    - *services
    - run:
        <<: *test_output
        name: perl-Pricing-Engine-European-Digital-Slope
        no_output_timeout: 3h
        command: |
          cd /home/git/regentmarkets/perl-Pricing-Engine-European-Digital-Slope
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make test
    - run:
        <<: *test_output
        name: perl-Pricing-Engine-BlackScholes
        no_output_timeout: 3h
        command: |
          cd /home/git/regentmarkets/perl-Pricing-Engine-BlackScholes
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make test
        when: always
    - run:
        <<: *test_output
        name: perl-Pricing-Engine-Digits
        no_output_timeout: 3h
        command: |
          cd /home/git/regentmarkets/perl-Pricing-Engine-Digits
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make test
        when: always
    - run:
        <<: *test_output
        name: perl-Pricing-Engine-HighLow-Ticks
        no_output_timeout: 3h
        command: |
          cd /home/git/regentmarkets/perl-Pricing-Engine-HighLow-Ticks
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make test
        when: always
    - run:
        <<: *test_output
        name: perl-Pricing-Engine-Intraday-Forex-Base
        no_output_timeout: 3h
        command: |
          cd /home/git/regentmarkets/perl-Pricing-Engine-Intraday-Forex-Base
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make test
        when: always
    - run:
        <<: *test_output
        name: perl-Pricing-Engine-Lookback
        no_output_timeout: 3h
        command: |
          cd /home/git/regentmarkets/perl-Pricing-Engine-Lookback
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make test
        when: always
    - run:
        <<: *test_output
        name: perl-Pricing-Engine-Markup
        no_output_timeout: 3h
        command: |
          cd /home/git/regentmarkets/perl-Pricing-Engine-Markup
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make test
        when: always
    - run:
        <<: *test_output
        name: perl-Pricing-Engine-Reset
        no_output_timeout: 3h
        command: |
          cd /home/git/regentmarkets/perl-Pricing-Engine-Reset
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make test
        when: always
    - run:
        <<: *test_output
        name: perl-Pricing-Engine-TickExpiry
        no_output_timeout: 3h
        command: |
          cd /home/git/regentmarkets/perl-Pricing-Engine-TickExpiry
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make test
        when: always
    - store_test_results:
        path: /var/tmp/test-output
  unit:
    <<: *default
    steps:
    - *ssh_keys
    - *update_git
    - run:
        <<: *test_output
        name: Run Unit Tests
        no_output_timeout: 3h
        command: |
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make unit
    - store_test_results:
        path: /var/tmp/test-output
  code_coverage:
    <<: *default
    steps:
    - *ssh_keys
    - *update_git
    - *services
    - run:
        <<: *test_output
        name: code coverage tests
        no_output_timeout: 3h
        command: make cover
workflows:
  version: 2
  build-workflow:
    jobs:
    - check_git_message
    - syntax_diff_unit:
        requires:
        - check_git_message
        context: perl
    - product_contract:
        requires:
        - syntax_diff_unit
        context: perl
    - validation:
        requires:
        - syntax_diff_unit
        context: perl
    - memory_test:
        requires:
        - syntax_diff_unit
        context: perl
    - pricing:
        requires:
        - syntax_diff_unit
        context: perl
    - product_others:
        requires:
        - syntax_diff_unit
        context: perl
    - benchmark_merlin_ovra:
        requires:
        - syntax_diff_unit
        context: perl
    - benchmark_SD:
        requires:
        - syntax_diff_unit
        context: perl
    - Pricing-Engine-Tests:
        requires:
        - syntax_diff_unit
        context: perl
  daily:
    jobs:
    - syntax_unit:
        context: perl
    - product_contract:
        context: perl
    - validation:
        context: perl
    - memory_test:
        context: perl
    - pricing:
        context: perl
    - product_others:
        context: perl
    - benchmark_merlin_ovra:
        context: perl
    - benchmark_SD:
        context: perl
    - Pricing-Engine-Tests:
        context: perl
    triggers:
    - schedule:
        cron: 30 22 * * *
        filters:
          branches:
            only:
            - master
  weekly-code-coverage:
    jobs:
    - code_coverage:
        context: perl
    triggers:
    - schedule:
        cron: 40 6 * * 6
        filters:
          branches:
            only:
            - master
