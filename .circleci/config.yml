version: 2
jobs:
  build:
    docker:
      - image: regentmarkets/debian-ci:latest
        user: nobody
        auth:
          username: circle4regentmarkets
          password: $DOCKERHUB_PASSWORD
    working_directory: /home/git/regentmarkets/bom-postgres
    steps:
      - add_ssh_keys:
          fingerprints:
            - "26:72:b1:08:0f:c1:3b:2b:2d:ea:61:7d:d6:11:63:fb"
      - checkout
      - run:
          name: Update git repositories
          command: /opt/circle/prepare-test.sh
      - run:
          name: Start services
          command: for i in authdb chronicle feed main users; do sudo pg_ctlcluster 9.6 $i start & done && sudo service binary_feeddb_pgbouncer restart & sudo service binary_pgbouncer restart & wait
      - run:
          name: Run tests
          command: echo '--formatter TAP::Formatter::JUnit' >> .proverc && sudo tee -a /etc/hosts < hosts.db && cat /etc/hosts && make test
          environment:
            PERL_TEST_HARNESS_DUMP_TAP: /var/tmp/test-output
            PERL5LIB: /home/git/regentmarkets/bom/lib:/home/git/regentmarkets/bom-postgres/lib:/home/git/regentmarkets/bom-platform/lib:/home/git/regentmarkets/bom-user/lib:/home/git/regentmarkets/bom-market/lib:/home/git/regentmarkets/bom-marketdataautoupdater/lib:/home/git/regentmarkets/bom-backoffice/lib:/home/git/regentmarkets/bom-myaffiliates/lib:/home/git/regentmarkets/binary-websocket-api/lib:/home/git/regentmarkets/bom-paymentapi/lib:/home/git/regentmarkets/bom-oauth/lib:/home/git/regentmarkets/bom-rpc/lib:/home/git/regentmarkets/bom-populator/lib:/home/git/regentmarkets/bom-feed/lib:/home/git/regentmarkets/bom-test/lib:/home/git/regentmarkets/php-mt5-webapi/lib:/home/git/regentmarkets/bom-transaction/lib:/home/git/regentmarkets/bom-pricing/lib:/home/git/regentmarkets/bom-cryptocurrency/lib:/home/git/regentmarkets/bom-user/lib:/home/git/regentmarkets/bom-config/lib
      - store_test_results:
          path: /var/tmp/test-output

workflows:
  version: 2
  build-workflow:
    jobs:
      - build:
          context: perl

