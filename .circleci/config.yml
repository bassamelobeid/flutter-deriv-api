jobs:
  build:
    docker:
    - auth:
        password: $DOCKERHUB_PASSWORD
        username: circle4regentmarkets
      image: regentmarkets/debian-ci:stable
      user: nobody
    steps:
    - add_ssh_keys:
        fingerprints:
        - 85:5e:13:f8:60:b2:55:a1:df:d1:8e:77:17:4c:3b:2d
    - checkout
    - run:
        name: Update git repositories
        command: /opt/circle/prepare-test.sh
    - run:
        name: Start services
        command: |
          start_services
          touch /tmp/services.ready
        background: true
    - run:
        name: Wait for services to start up
        command: |
          count=0
          while [ ! -f /tmp/services.ready ]; do
              echo 'Still waiting for services...'
              (( count++ )) && (( count >= 20 )) && break
              sleep 1
          done
    - run:
        command: |
          source /etc/profile.d/perl5.sh
          make test
        name: Run test
    shell: /bin/bash -leo pipefail
    working_directory: /home/git/regentmarkets/bom-commission-management-service
version: 2
workflows:
  build-workflow:
    jobs: &1
    - build:
        context: perl
  daily:
    jobs: *1
    triggers:
    - schedule:
        cron: 2 20 * * *
        filters:
          branches:
            only:
            - master
  version: 2
