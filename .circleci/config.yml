---
alias:
- &ssh_keys
  add_ssh_keys:
    fingerprints:
    - 85:5e:13:f8:60:b2:55:a1:df:d1:8e:77:17:4c:3b:2d
- &update_git
  run:
    no_output_timeout: 3h
    command: /opt/circle/prepare-test.sh
    name: Update git repositories
- &start_services
  run:
    command: |
      sudo mkdir -p /var/lib/binary && sudo chown nobody:nogroup /var/lib/binary # this line should be dropped when we switch json schema v3 to v4
      start_services
      touch /tmp/services.ready
    name: Start services
- &environment
  environment:
    PERL_TEST_HARNESS_DUMP_TAP: /var/tmp/test-output
    RPC_CONFIG: /home/git/regentmarkets/bom-rpc/rpc.conf.travis
    WEBSOCKET_CONFIG: /home/git/regentmarkets/binary-websocket-api/websocket.conf.example
- &debian-ci
  auth:
    password: $DOCKERHUB_PASSWORD
    username: circle4regentmarkets
  image: regentmarkets/debian-ci:stable
  user: nobody

default: &test_config
  docker:
  - *debian-ci
  shell: /bin/bash -leo pipefail
  working_directory: /home/git/regentmarkets/binary-websocket-api

jobs:
  accounts:
    <<: *test_config
    steps:
    - *ssh_keys
    - *update_git
    - *start_services
    - run:
        <<: *environment
        no_output_timeout: 3h
        command: |
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make accounts
        name: Accounts-related functionality
    - store_test_results:
        path: /var/tmp/test-output
  misc:
    <<: *test_config
    steps:
    - *ssh_keys
    - *update_git
    - *start_services
    - run:
        <<: *environment
        no_output_timeout: 3h
        command: |
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make misc
        name: Uncategorised tests
    - store_test_results:
        path: /var/tmp/test-output
  p2p:
    <<: *test_config
    steps:
    - *ssh_keys
    - *update_git
    - *start_services
    - run:
        <<: *environment
        no_output_timeout: 3h
        command: |
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make p2p
        name: Run P2P tests
    - store_test_results:
        path: /var/tmp/test-output
  pricing:
    <<: *test_config
    steps:
    - *ssh_keys
    - *update_git
    - *start_services
    - run:
        <<: *environment
        no_output_timeout: 3h
        command: |
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make pricing
        name: Pricing
    - store_test_results:
        path: /var/tmp/test-output
  schema:
    <<: *test_config
    steps:
    - *ssh_keys
    - *update_git
    - *start_services
    - run:
        <<: *environment
        no_output_timeout: 3h
        command: |
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make schema
        name: Schema tests
    - store_test_results:
        path: /var/tmp/test-output
  security:
    <<: *test_config
    steps:
    - *ssh_keys
    - *update_git
    - *start_services
    - run:
        <<: *environment
        no_output_timeout: 3h
        command: |
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make security
        name: Security handling
    - store_test_results:
        path: /var/tmp/test-output
  structure:
    <<: *test_config
    steps:
    - *ssh_keys
    - *update_git
    - *start_services
    - run:
        <<: *environment
        no_output_timeout: 3h
        command: |
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make structure
        name: Code structure and syntax
    - run:
        no_output_timeout: 3h
        command: make unit
        name: unit tests
    - store_test_results:
        path: /var/tmp/test-output
  subscriptions:
    <<: *test_config
    steps:
    - *ssh_keys
    - *update_git
    - *start_services
    - run:
        <<: *environment
        no_output_timeout: 3h
        command: |
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make subscriptions
        name: Run subscription tests
    - store_test_results:
        path: /var/tmp/test-output
  backends:
    <<: *test_config
    steps:
    - *ssh_keys
    - *update_git
    - *start_services
    - run:
        <<: *environment
        no_output_timeout: 3h
        command: |
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make backends
        name: Run backends tests
    - store_test_results:
        path: /var/tmp/test-output
  update_docs:
    <<: *test_config
    steps:
    - *ssh_keys
    - *update_git
    - run:
        <<: *environment
        no_output_timeout: 3h
        command: |
          script/websocket_schema_update.sh
        name: Update developer.binary.com schema documentation
  code_coverage:
    <<: *test_config
    <<: *environment
    steps:
    - *ssh_keys
    - *update_git
    - *start_services
    - run:
        no_output_timeout: 3h
        command: make cover
        name: code cover tests
    - run:
        no_output_timeout: 3h
        command: make cover_websocket_tests sub_test=schema_suite
        name: schema_suite tests
    - run:
        no_output_timeout: 3h
        command: make cover_websocket_tests sub_test=security
        name: security tests
    - run:
        no_output_timeout: 3h
        command: make cover_websocket_tests sub_test=accounts
        name: accounts tests
    - run:
        no_output_timeout: 3h
        command: make cover_websocket_tests sub_test=misc
        name: misc tests
    - run:
        no_output_timeout: 3h
        command: make cover_websocket_tests sub_test=p2p
        name: p2p tests
    - run:
        no_output_timeout: 3h
        command: make cover_websocket_tests sub_test=pricing
        name: pricing tests
    - run:
        no_output_timeout: 3h
        command: make cover_websocket_tests sub_test=backends
        name: backends tests
    - run:
        name: upload coverage report
        no_output_timeout: 3h
        command: cover -report coveralls
  unit:
    <<: *test_config
    steps:
    - *ssh_keys
    - *update_git
    - run:
        <<: *environment
        no_output_timeout: 3h
        command: |
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make unit
        name: Run Unit tests
    - store_test_results:
        path: /var/tmp/test-output
version: 2
workflows:
  build-workflow:
    jobs: &all-jobs
    - structure:
        context: perl
    - accounts:
        context: perl
    - security:
        context: perl
    - pricing:
        context: perl
    - misc:
        context: perl
    - p2p:
        context: perl
    - schema:
        context: perl
    - subscriptions:
        context: perl
    - backends:
        context: perl
    - update_docs:
        context: perl
        filters:
          branches:
            only:
            - master
  daily:
    jobs: *all-jobs
    triggers:
    - schedule:
        cron: 36 20 * * *
        filters:
          branches:
            only:
            - master
  weekly-code-coverage:
    jobs:
    - code_coverage:
        context: perl
    triggers:
    - schedule:
        cron: 30 7 * * 6
        filters:
          branches:
            only:
            - master
  version: 2
