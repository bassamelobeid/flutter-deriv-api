---
alias:
- &1
  add_ssh_keys:
    fingerprints:
    - 26:72:b1:08:0f:c1:3b:2b:2d:ea:61:7d:d6:11:63:fb
- &2
  run:
    command: /opt/circle/prepare-test.sh
    name: Update git repositories
- &3
  run:
    background: true
    command: |
      start_services
      touch /tmp/services.ready
    name: Start services
- &4
  run:
    command: |
      count=0
      while [ ! -f /tmp/services.ready ]; do
          echo 'Still waiting for services...'
          (( count++ )) && (( count >= 20 )) && break
          sleep 1
      done
    name: Wait for services to start up
- &5
  environment:
    PERL_TEST_HARNESS_DUMP_TAP: /var/tmp/test-output
    RPC_CONFIG: /home/git/regentmarkets/bom-rpc/rpc.conf.travis
    LOG_LEVEL: debug
- &check_services
  run:
    background: true
    command: /opt/circle/check_services
    name: Check services are running
- &debian-ci
  auth:
    password: $DOCKERHUB_PASSWORD
    username: circle4regentmarkets
  image: regentmarkets/debian-ci:stable
  user: nobody
default: &6
  resource_class: small
  docker:
  - *debian-ci
  shell: /bin/bash -leo pipefail
  working_directory: /home/git/regentmarkets/bom-rpc
jobs:
  check_git_message:
    resource_class: small
    docker:
    - image: alpine/git:2.36.2
      entrypoint: /bin/sh
    steps:
    - checkout
    - run:
        command: |
          if [[ -n "$CIRCLE_PULL_REQUEST" && $CIRCLE_BRANCH != "master" ]]; then
            export GIT_COMMIT_DESC="$(git log --format=oneline -n 1 $CIRCLE_SHA1)";
            if echo $GIT_COMMIT_DESC | grep -E "\[\s*\bci\b.*]"; then exit 0; else exit 1; fi
          else
            exit 0
          fi
        name: Check git message if it contains the keyword [ci]
  schema:
    <<: *6
    steps:
    - *1
    - *2
    - *3
    - *4
    - *check_services
    - run:
        <<: *5
        command: |
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make json_schemas
        name: Run json_schemas tests
    - store_test_results:
        path: /var/tmp/test-output
  syntax_unit:
    <<: *6
    steps:
    - *1
    - *2
    - run:
        <<: *5
        command: |
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make syntax
        name: Code structure and syntax
    - run:
        command: make unit
        name: unit tests
    - store_test_results:
        path: /var/tmp/test-output
  syntax_diff:
    <<: *6
    steps:
    - *1
    - *2
    - run:
        <<: *5
        command: |
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make syntax_diff
        name: Code structure and syntax
    - store_test_results:
        path: /var/tmp/test-output
  schemas_unit:
    <<: *6
    steps:
    - *1
    - *2
    - *3
    - *4
    - *check_services
    - run:
        <<: *5
        command: |
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make json_schemas
        name: Run json_schemas tests
    - run:
        command: make unit
        name: unit tests
    - store_test_results:
        path: /var/tmp/test-output
  core1:
    <<: *6
    steps:
    - *1
    - *2
    - *3
    - *4
    - *check_services
    - run:
        <<: *5
        command: |
          sudo touch /var/log/fixedodds/audit.log
          sudo chown nobody:nogroup /var/log/fixedodds/audit.log
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make test1
        name: Run tests
    - store_test_results:
        path: /var/tmp/test-output
  core2:
    <<: *6
    steps:
    - *1
    - *2
    - *3
    - *4
    - *check_services
    - run:
        <<: *5
        command: |
          sudo touch /var/log/fixedodds/audit.log
          sudo chown nobody:nogroup /var/log/fixedodds/audit.log
          # circleci need output in 10 minutes. Otherwise it will fail
          while :; do echo -n "."; sleep 300; done &
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make test2
        name: Run tests
        no_output_timeout: 30m
    - store_test_results:
        path: /var/tmp/test-output
  unit:
    <<: *6
    steps:
    - *1
    - *2
    - run:
        <<: *5
        command: |
          echo '--formatter TAP::Formatter::JUnit' >> .proverc
          make unit
        name: Unit tests
    - store_test_results:
        path: /var/tmp/test-output
  code_coverage:
    <<: *6
    steps:
    - *1
    - *2
    - *3
    - *4
    - *check_services
    - run:
        <<: *5
        command: make cover
        name: code coverage tests
version: 2
workflows:
  build-workflow:
    jobs:
    - check_git_message
    - syntax_diff:
        requires:
        - check_git_message
        context: perl
    - schemas_unit:
        requires:
        - syntax_diff
        context: perl
    - core1:
        requires:
        - syntax_diff
        context: perl
    - core2:
        requires:
        - syntax_diff
        context: perl
  daily:
    jobs:
    - syntax_unit:
        context: perl
    - core1:
        context: perl
    - core2:
        context: perl
    - schema:
        context: perl
    triggers:
    - schedule:
        cron: 28 20 * * *
        filters:
          branches:
            only:
            - master
  weekly-code-coverage:
    jobs:
    - code_coverage:
        context: perl
    triggers:
    - schedule:
        cron: 50 5 * * 6
        filters:
          branches:
            only:
            - master
  version: 2
