sudo: required
dist: precise
group: deprecated-2017Q1
language: perl
matrix:
    fast_finish: true
jobs:
    include:
        - stage: syntax
          script: make unit_test_syntax
        - stage: pricing
          name: unit_test_initial
          script: make unit_test_initial
        - name: unit_test_product_contract
          script: make unit_test_product_contract
        - name: unit_test_product_contract_extended
          script: make unit_test_product_contract_extended
        - name: unit_test_product_all
          script: make unit_test_product_all
        - name: unit_test_validation
          script: make unit_test_validation
        - name: unit_test_pricing
          script: make unit_test_pricing
        - name: unit_test_intraday
          script: make unit_test_intraday
        - stage: merlin
          name: merlin_benchmark
          script: cd /home/git/regentmarkets/bom-quant-benchmark && make merlin_benchmark
        - name: SDFX_benchmark_major
          script: cd /home/git/regentmarkets/bom-quant-benchmark && make SDFX_benchmark_major
        - name: SDFX_benchmark_minor
          script: cd /home/git/regentmarkets/bom-quant-benchmark && make SDFX_benchmark_minor
        - name: SDEQ_benchmark_DJI
          script: cd /home/git/regentmarkets/bom-quant-benchmark && make SDEQ_benchmark_DJI
        - name: SDEQ_benchmark_FCHI
          script: cd /home/git/regentmarkets/bom-quant-benchmark && make SDEQ_benchmark_FCHI
        - name: SDEQ_benchmark_SPC
          script: cd /home/git/regentmarkets/bom-quant-benchmark && make SDEQ_benchmark_SPC
        - name: SDEQ_benchmark_N225
          script: cd /home/git/regentmarkets/bom-quant-benchmark && make SDEQ_benchmark_N225
        - name: SDEQ_benchmark_SSECOMP
          script: cd /home/git/regentmarkets/bom-quant-benchmark && make SDEQ_benchmark_SSECOMP
        - name: SDEQ_benchmark_FTSE
          script: cd /home/git/regentmarkets/bom-quant-benchmark && make SDEQ_benchmark_FTSE
        - name: OVRA_benchmark
          script: cd /home/git/regentmarkets/bom-quant-benchmark && make OVRA_benchmark
        - stage: engines
          name: perl-Pricing-Engine-European-Digital-Slope
          script: cd /home/git/regentmarkets/perl-Pricing-Engine-European-Digital-Slope && make test
        - name: perl-Pricing-Engine-BlackScholes
          script: cd /home/git/regentmarkets/perl-Pricing-Engine-BlackScholes && make test
        - name: perl-Pricing-Engine-Digits
          script: cd /home/git/regentmarkets/perl-Pricing-Engine-Digits && make test
        - name: perl-Pricing-Engine-HighLow-Ticks
          script: cd /home/git/regentmarkets/perl-Pricing-Engine-HighLow-Ticks && make test
        - name: perl-Pricing-Engine-Intraday-Forex-Base
          script: cd /home/git/regentmarkets/perl-Pricing-Engine-Intraday-Forex-Base && make test
        - name: perl-Pricing-Engine-Lookback
          script: cd /home/git/regentmarkets/perl-Pricing-Engine-Lookback && make test
        - name: perl-Pricing-Engine-Markup
          script: cd /home/git/regentmarkets/perl-Pricing-Engine-Markup && make test
        - name: perl-Pricing-Engine-Reset
          script: cd /home/git/regentmarkets/perl-Pricing-Engine-Reset && make test
        - name: perl-Pricing-Engine-TickExpiry
          script: cd /home/git/regentmarkets/perl-Pricing-Engine-TickExpiry && make test

stages:
    - syntax
    - pricing
    - name: merlin
      if: not type in (pull_request)
    - engines

notifications:
    slack:
        rooms:
            - binary-group:6t92829RicGEft1kCkpKLPj9#test-failures
        on_success: never
        on_failure: always
        on_pull_requests: false

services:
    - redis-server
cache: apt
before_install:
    - git clone ssh://git@github.com/regentmarkets/travis-scripts /tmp/travis-scripts-init
    - /tmp/travis-scripts-init/clone_branch.sh regentmarkets/travis-scripts
    - /tmp/travis-scripts/setup_ssh.sh
    - sudo mkdir -p /home/git/binary-com
    - sudo mkdir -p /home/git/regentmarkets
    - . /tmp/travis-scripts/setup_perl.sh
    - /tmp/travis-scripts/fixHostName.sh

    - /tmp/travis-scripts/parallel_clone_branch.sh
      regentmarkets/bom-test
      regentmarkets/bom-config
      regentmarkets/bom-platform
      regentmarkets/bom-postgres
      regentmarkets/bom-market
      regentmarkets/bom-quant-benchmark
      binary-com/translations-websockets-api
      regentmarkets/perl-Pricing-Engine-European-Digital-Slope
      regentmarkets/perl-Pricing-Engine-BlackScholes
      regentmarkets/perl-Pricing-Engine-Digits
      regentmarkets/perl-Pricing-Engine-HighLow-Ticks
      regentmarkets/perl-Pricing-Engine-Intraday-Forex-Base
      regentmarkets/perl-Pricing-Engine-Lookback
      regentmarkets/perl-Pricing-Engine-Markup
      regentmarkets/perl-Pricing-Engine-Reset
      regentmarkets/perl-Pricing-Engine-TickExpiry

    - /tmp/travis-scripts/postgres_restart.sh
    - /tmp/travis-scripts/redis.sh

install:
    - source /tmp/travis-scripts/devbox_path.sh
    - sudo ln -s $PWD /home/git/regentmarkets/bom
    - /tmp/travis-scripts/devbox.sh *.yml

    - /tmp/travis-scripts/remove_postgresdb_config.sh
    - /tmp/travis-scripts/setup_feeddb.sh
    - /tmp/travis-scripts/setup_chronicledb.sh

    - /tmp/travis-scripts/setup_logs.sh
    - . /tmp/travis-scripts/setup_perl5lib.sh

after_script:
    - /tmp/travis-scripts/wait_for_ssh.sh
