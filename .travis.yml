language: perl
perl:
    - "5.14.2"
env:
    - TEST_SUITE=unit_test_platform_client
    - TEST_SUITE=unit_test_platform_all
    - TEST_SUITE=unit_test_myaffiliates_extended
    - TEST_SUITE=unit_test_system
    - TEST_SUITE=leaktest
    - TEST_SUITE=syntax_lib
services:
    - redis-server
addons:
    postgresql: "9.3"
cache: apt
before_install:
    - git clone https://60d764d753f8b0b231f5a4ee566d3eeaf5024cdc@github.com/regentmarkets/travis-scripts /tmp/travis-scripts
    - /tmp/travis-scripts/fixHostName.sh
    - /tmp/travis-scripts/postgres.sh
    - sudo mkdir -p /home/git/regentmarkets /home/git/binary-com

    - /tmp/travis-scripts/couchdb.sh

    - /tmp/travis-scripts/clone_branch.sh regentmarkets/cpan
    - /tmp/travis-scripts/clone_branch.sh regentmarkets/bom-test
    - /tmp/travis-scripts/clone_branch.sh regentmarkets/bom-utility
    - /tmp/travis-scripts/clone_branch.sh regentmarkets/bom
    - /tmp/travis-scripts/clone_branch.sh regentmarkets/bom-postgres
    - /tmp/travis-scripts/clone_branch.sh regentmarkets/bom-market
    - /tmp/travis-scripts/clone_branch.sh binary-com/binary-static gh-pages

    - /tmp/travis-scripts/postgres_restart.sh


install:
    - source /tmp/travis-scripts/devbox_path.sh
    - sudo ln -s $PWD /home/git/regentmarkets/bom-platform
    - /tmp/travis-scripts/devbox.sh *.yml

    - /tmp/travis-scripts/remove_postgresdb_config.sh
    - /tmp/travis-scripts/setup_clientdb.sh
    - /tmp/travis-scripts/setup_feeddb.sh
    - /tmp/travis-scripts/setup_authdb.sh
    - /tmp/travis-scripts/setup_usersdb.sh
    - /tmp/travis-scripts/setup_chronicledb.sh

    - /tmp/travis-scripts/setup_logs.sh
    - . /tmp/travis-scripts/setup_perl5lib.sh
    - /tmp/travis-scripts/redis.sh
    - echo "{\"global\":{\"marketing\":{\"email\":\"test@binary.com\",\"myaffiliates_email\":\"test@binary.com\"},\"payments\":{\"email\":\"test@binary.com\",\"payment_limits\":\"{\\\"test\\\" : 100000\\n}\\n\"},\"system\":{\"suspend\":{\"new_accounts\":0,\"payments\":0,\"system\":\"0\",\"payment_agents\":0,\"trading\":\"0\",\"all_logins\":\"0\",\"logins\":[]}},\"cgi\":{\"allowed_languages\":[\"EN\",\"ID\",\"RU\",\"ES\",\"FR\",\"PT\",\"DE\",\"ZH_CN\",\"JA\",\"AR\",\"PL\",\"VI\",\"ZH_TW\",\"IT\"],\"backoffice\":{\"static_url\":\"https://regentmarkets.github.io/binary-static-backoffice/\"},\"terms_conditions_version\":\"Version 39 2015-12-04\"},\"quants\":{\"underlyings\":{\"disabled_due_to_corporate_actions\":[]},\"features\":{\"enable_pricedebug\":1,\"suspend_claim_types\":[],\"enable_parameterized_surface\":\"1\",\"enable_portfolio_autosell\":1},\"markets\":{\"disabled\":[\"sectors\"],\"disable_iv\":[]},\"client_limits\":{\"spreads_daily_profit_limit\":\"10000\",\"digits_turnover_limit\":\"300000\",\"tick_expiry_turnover_limit\":\"500000\",\"asian_turnover_limit\":\"50000\",\"payout_per_symbol_and_bet_type_limit\":\"200000\",\"smarties_turnover_limit\":\"100000\",\"intraday_spot_index_turnover_limit\":\"30000\",\"tick_expiry_engine_turnover_limit\":\"0.5\",\"intraday_forex_iv\":\"{\\n   \\\"potential_profit\\\" : 35000,\\n   \\\"realized_profit\\\" : 35000,\\n   \\\"turnover\\\" : 35000\\n}\\n\"},\"bet_limits\":{\"maximum_payout\":\"\",\"maximum_payout_on_less_than_7day_indices_call_put\":\"5000\",\"maximum_payout_on_new_markets\":\"100\",\"maximum_tick_trade_stake\":\"1000\",\"holiday_blackout_start\":\"345\",\"holiday_blackout_end\":\"5\"},\"market_data\":{\"interest_rates_source\":\"implied\",\"economic_announcements_source\":\"forexfactory\",\"volsurface_calibration_error_threshold\":\"40\",\"extra_vol_diff_by_delta\":\"0.1\"},\"commission\":{\"adjustment\":{\"minimum\":\"1\",\"maximum\":\"500\",\"quanto_scale_factor\":\"1\",\"spread_multiplier\":\"1\",\"bom_created_bet\":\"100\",\"news_factor\":\"1\",\"forward_start_factor\":\"1.5\",\"global_scaling\":\"100\"},\"intraday\":{\"historical_iv_risk\":\"10\",\"historical_vol_meanrev\":\"0.10\",\"historical_fixed\":\"0.0125\",\"historical_bounceback\":\"{}\\n\"},\"maximum_total_markup\":\"50\",\"minimum_total_markup\":\"0.3\",\"resell_discount_factor\":\"0.2\",\"digital_spread\":{\"level_multiplier\":\"1.4\"},\"equality_discount_retained\":\"1\"}}},\"_rev\":1453762804}" | perl -MBOM::System::Chronicle -MJSON -e 'BOM::System::Chronicle::set("app_settings", "binary", JSON::from_json(<>));'
    - perl -MBOM::System::Chronicle -MData::Dumper -e 'print Dumper(BOM::System::Chronicle::get("app_settings", "binary"))'
script:
    - make $TEST_SUITE; RC=$?; sudo service binary_pgbouncer status; exit $RC
