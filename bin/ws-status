#!/etc/rmg/bin/perl
use strict;
use warnings;

use FindBin qw/$Bin/;
use lib "$Bin/../lib";
# load this file to force Mojo::JSON to use JSON::MaybeXS
use Mojo::JSON::MaybeXS;
use Mojo::JSON 'encode_json';
use YAML::XS;
use Mojo::Redis2;
use Encode;
use Getopt::Long qw(GetOptions :config no_auto_abbrev no_ignore_case);

use Binary::WebSocketAPI::v3::Instance::Redis 'ws_redis_master';

STDOUT->autoflush(1);

GetOptions(
    's|status=s'           => \my $status,
    'o|notifications-on=i' => \my $is_on,
    'm|message=s'          => \my $message,
    'h|help'               => \my $help,
);

my $show_help = $help;
die <<"EOF" if (!($status || defined $is_on || $message) || $show_help);
usage: $0 OPTIONS
These options are available:
  -s, --status                   Site status. up or down. up by default
  -o, --notifications-on         Notifications turn on/off ( 1 or 0 ). 1 by default
  -m, --message                  Message ( in quotes )
  -h, --help                     Show this message.
EOF

if (!$is_on || $is_on != 0 && $is_on != 1) {
    $is_on = 1;
}

if (!$status || $status ne 'up' && $status ne 'down') {
    $status = 'up';
}

my $channel_name = "NOTIFY::broadcast::channel";
my $state_key    = "NOTIFY::broadcast::state";
my $is_on_key    = "NOTIFY::broadcast::is_on";     ### TODO: to config

my $redis = ws_redis_master() or die 'no redis connection';
$redis->on(
    error => sub {
        my ($self, $err) = @_;
        warn "ws write redis error: $err";
    });

if ($status || $message) {
    my $is_on_value = $is_on;
    print $redis->set($is_on_key, $is_on_value), "\n" if $is_on_value;

    my $mess_obj = Encode::encode_utf8(
        encode_json({
                site_status => $status // "up",
                message     => $message // ""
            }));
    print $redis->set($state_key, $mess_obj), "\n";

    my $subscribes_count = $redis->publish($channel_name, $mess_obj);
    print $subscribes_count . " workers subscribed\n";
}
