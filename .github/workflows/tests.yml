name: Tests
run-name: Tests
env:
    PERL_TEST_HARNESS_DUMP_TAP: /tmp/test-output
on:
  workflow_call:
    inputs:
      debianci_image:
        description: 'Docker container used by the workflow'
        required: false
        default: ${{ vars.DEBIAN_CI }}
        type: string
      is_dependent:
        description: 'Boolean to check if its part of dependent test'
        required: false
        default: false
        type: boolean
      repository:
        description: 'Repository name for running tests'
        required: false
        default: regentmarkets/binary-websocket-api
        type: string 
jobs:
    accounts:
        runs-on: ubuntu-latest
        container:
          image: ${{ inputs.debianci_image }}
          credentials:
            username: circle4regentmarkets
            password: ${{ secrets.DOCKER_PASSWORD }}
          options: --user nobody:nogroup
        defaults:
          run:
            shell: bash -le {0}
            working-directory: /home/git/${{ inputs.repository }}
        env:
          LOG_LEVEL: debug
          RPC_CONFIG: /home/git/regentmarkets/bom-rpc/rpc.conf.travis
          WEBSOCKET_CONFIG: /home/git/regentmarkets/binary-websocket-api/websocket.conf.example
        steps:
          - 
            name: setup CI step
            uses: regentmarkets/github-actions/ci-setup@master
            with:
              read_github_ssh_key: ${{ secrets.READ_GITHUB_SSH_KEY }}
              repository: ${{ inputs.repository }}
          - 
            name: Accounts-related functionality
            run: make accounts formatter='--formatter TAP::Formatter::JUnit::PrintTxtStdout'
          - 
            name: Update UID for nobody user
            uses: regentmarkets/github-actions/update-uid@master
          - 
            name : Upload test results
            uses: actions/upload-artifact@26f96dfa697d77e81fd5907df203aa23a56210a8 #v4.3.0
            if: ${{ !inputs.is_dependent && ( success() || failure() ) }}
            with:
              name: test-results-accounts
              path: /tmp/test-output/**/*.xml
              retention-days: 1
    security:
        runs-on: ubuntu-latest
        container:
          image: ${{ inputs.debianci_image }}
          credentials:
            username: circle4regentmarkets
            password: ${{ secrets.DOCKER_PASSWORD }}
          options: --user nobody:nogroup
        defaults:
          run:
            shell: bash -le {0}
            working-directory: /home/git/${{ inputs.repository }}
        env:
          LOG_LEVEL: debug
          RPC_CONFIG: /home/git/regentmarkets/bom-rpc/rpc.conf.travis
          WEBSOCKET_CONFIG: /home/git/regentmarkets/binary-websocket-api/websocket.conf.example
        steps:
          - 
            name: setup CI step
            uses: regentmarkets/github-actions/ci-setup@master
            with:
              read_github_ssh_key: ${{ secrets.READ_GITHUB_SSH_KEY }}
              repository: ${{ inputs.repository }}
          - 
            name: Security handling
            run: make security formatter='--formatter TAP::Formatter::JUnit::PrintTxtStdout'

          - 
            name: Update UID for nobody user
            uses: regentmarkets/github-actions/update-uid@master

          - 
            name : Upload test results
            uses: actions/upload-artifact@26f96dfa697d77e81fd5907df203aa23a56210a8 #v4.3.0
            if: ${{ !inputs.is_dependent && ( success() || failure() ) }}
            with:
              name: test-results-security
              path: /tmp/test-output/**/*.xml
              retention-days: 1
    pricing:
        runs-on: ubuntu-latest
        container:
          image: ${{ inputs.debianci_image }}
          credentials:
            username: circle4regentmarkets
            password: ${{ secrets.DOCKER_PASSWORD }}
          options: --user nobody:nogroup
        defaults:
          run:
            shell: bash -le {0}
            working-directory: /home/git/${{ inputs.repository }}
        env:
          LOG_LEVEL: debug
          RPC_CONFIG: /home/git/regentmarkets/bom-rpc/rpc.conf.travis
          WEBSOCKET_CONFIG: /home/git/regentmarkets/binary-websocket-api/websocket.conf.example
        steps:
          - 
            name: setup CI step
            uses: regentmarkets/github-actions/ci-setup@master
            with:
              read_github_ssh_key: ${{ secrets.READ_GITHUB_SSH_KEY }}
              repository: ${{ inputs.repository }}
          - 
            name: Pricing
            run: make pricing formatter='--formatter TAP::Formatter::JUnit::PrintTxtStdout'
          - 
            name: Update UID for nobody user
            uses: regentmarkets/github-actions/update-uid@master
          - 
            name : Upload test results
            uses: actions/upload-artifact@26f96dfa697d77e81fd5907df203aa23a56210a8 #v4.3.0
            if: ${{ !inputs.is_dependent && ( success() || failure() ) }}
            with:
              name: test-results-pricing
              path: /tmp/test-output/**/*.xml
              retention-days: 1
    misc:
        runs-on: ubuntu-latest
        container:
          image: ${{ inputs.debianci_image }}
          credentials:
            username: circle4regentmarkets
            password: ${{ secrets.DOCKER_PASSWORD }}
          options: --user nobody:nogroup
        defaults:
          run:
            shell: bash -le {0}
            working-directory: /home/git/${{ inputs.repository }}
        env:
          LOG_LEVEL: debug
          RPC_CONFIG: /home/git/regentmarkets/bom-rpc/rpc.conf.travis
          WEBSOCKET_CONFIG: /home/git/regentmarkets/binary-websocket-api/websocket.conf.example
        steps:
          - 
            name: setup CI step
            uses: regentmarkets/github-actions/ci-setup@master
            with:
              read_github_ssh_key: ${{ secrets.READ_GITHUB_SSH_KEY }}
              repository: ${{ inputs.repository }}
          - 
            name: Uncategorised tests
            run: make misc formatter='--formatter TAP::Formatter::JUnit::PrintTxtStdout'
          - 
            name: Update UID for nobody user
            uses: regentmarkets/github-actions/update-uid@master
          - 
            name : Upload test results
            uses: actions/upload-artifact@26f96dfa697d77e81fd5907df203aa23a56210a8 #v4.3.0
            if: ${{ !inputs.is_dependent && ( success() || failure() ) }}
            with:
              name: test-results-misc
              path: /tmp/test-output/**/*.xml
              retention-days: 1 
    p2p:
        runs-on: ubuntu-latest
        container:
          image: ${{ inputs.debianci_image }}
          credentials:
            username: circle4regentmarkets
            password: ${{ secrets.DOCKER_PASSWORD }}
          options: --user nobody:nogroup
        defaults:
          run:
            shell: bash -le {0}
            working-directory: /home/git/${{ inputs.repository }}
        env:
          LOG_LEVEL: debug
          RPC_CONFIG: /home/git/regentmarkets/bom-rpc/rpc.conf.travis
          WEBSOCKET_CONFIG: /home/git/regentmarkets/binary-websocket-api/websocket.conf.example
        steps:
          - 
            name: setup CI step
            uses: regentmarkets/github-actions/ci-setup@master
            with:
              read_github_ssh_key: ${{ secrets.READ_GITHUB_SSH_KEY }}
              repository: ${{ inputs.repository }}
          - 
            name: Run P2P tests
            run: make p2p formatter='--formatter TAP::Formatter::JUnit::PrintTxtStdout'
          - 
            name: Update UID for nobody user
            uses: regentmarkets/github-actions/update-uid@master
          - 
            name : Upload test results
            uses: actions/upload-artifact@26f96dfa697d77e81fd5907df203aa23a56210a8 #v4.3.0
            if: ${{ !inputs.is_dependent && ( success() || failure() ) }}
            with:
              name: test-results-p2p
              path: /tmp/test-output/**/*.xml
              retention-days: 1
    schema:
        runs-on: ubuntu-latest
        container:
          image: ${{ inputs.debianci_image }}
          credentials:
            username: circle4regentmarkets
            password: ${{ secrets.DOCKER_PASSWORD }}
          options: --user nobody:nogroup
        defaults:
          run:
            shell: bash -le {0}
            working-directory: /home/git/${{ inputs.repository }}
        env:
          LOG_LEVEL: debug
          RPC_CONFIG: /home/git/regentmarkets/bom-rpc/rpc.conf.travis
          WEBSOCKET_CONFIG: /home/git/regentmarkets/binary-websocket-api/websocket.conf.example
        steps:
          - 
            name: setup CI step
            uses: regentmarkets/github-actions/ci-setup@master
            with:
              read_github_ssh_key: ${{ secrets.READ_GITHUB_SSH_KEY }}
              repository: ${{ inputs.repository }}
          - 
            name: Schema tests
            run: make schema formatter='--formatter TAP::Formatter::JUnit::PrintTxtStdout'
          - 
            name: Update UID for nobody user
            uses: regentmarkets/github-actions/update-uid@master
          - 
            name : Upload test results
            uses: actions/upload-artifact@26f96dfa697d77e81fd5907df203aa23a56210a8 #v4.3.0
            if: ${{ !inputs.is_dependent && ( success() || failure() ) }}
            with:
              name: test-results-schema
              path: /tmp/test-output/**/*.xml
              retention-days: 1
    subscriptions:
        runs-on: ubuntu-latest
        container:
          image: ${{ inputs.debianci_image }}
          credentials:
            username: circle4regentmarkets
            password: ${{ secrets.DOCKER_PASSWORD }}
          options: --user nobody:nogroup
        defaults:
          run:
            shell: bash -le {0}
            working-directory: /home/git/${{ inputs.repository }}
        env:
          LOG_LEVEL: debug
          RPC_CONFIG: /home/git/regentmarkets/bom-rpc/rpc.conf.travis
          WEBSOCKET_CONFIG: /home/git/regentmarkets/binary-websocket-api/websocket.conf.example
        steps:
          - 
            name: setup CI step
            uses: regentmarkets/github-actions/ci-setup@master
            with:
              read_github_ssh_key: ${{ secrets.READ_GITHUB_SSH_KEY }}
              repository: ${{ inputs.repository }}
          - 
            name: Run subscription tests
            run: make subscriptions formatter='--formatter TAP::Formatter::JUnit::PrintTxtStdout'
          - 
            name: Update UID for nobody user
            uses: regentmarkets/github-actions/update-uid@master
          - 
            name : Upload test results
            uses: actions/upload-artifact@26f96dfa697d77e81fd5907df203aa23a56210a8 #v4.3.0
            if: ${{ !inputs.is_dependent && ( success() || failure() ) }}
            with:
              name: test-results-subscriptions
              path: /tmp/test-output/**/*.xml
              retention-days: 1 
    backends:
        runs-on: ubuntu-latest
        container:
          image: ${{ inputs.debianci_image }}
          credentials:
            username: circle4regentmarkets
            password: ${{ secrets.DOCKER_PASSWORD }}
          options: --user nobody:nogroup
        defaults:
          run:
            shell: bash -le {0}
            working-directory: /home/git/${{ inputs.repository }}
        env:
          LOG_LEVEL: debug
          RPC_CONFIG: /home/git/regentmarkets/bom-rpc/rpc.conf.travis
          WEBSOCKET_CONFIG: /home/git/regentmarkets/binary-websocket-api/websocket.conf.example
        steps:
          - 
            name: setup CI step
            uses: regentmarkets/github-actions/ci-setup@master
            with:
              read_github_ssh_key: ${{ secrets.READ_GITHUB_SSH_KEY }}
              repository: ${{ inputs.repository }}
          - 
            name: Run backends tests
            run: make backends formatter='--formatter TAP::Formatter::JUnit::PrintTxtStdout'
          - 
            name: Update UID for nobody user
            uses: regentmarkets/github-actions/update-uid@master
          - 
            name : Upload test results
            uses: actions/upload-artifact@26f96dfa697d77e81fd5907df203aa23a56210a8 #v4.3.0
            if: ${{ !inputs.is_dependent && ( success() || failure() ) }}
            with:
              name: test-results-backends
              path: /tmp/test-output/**/*.xml
              retention-days: 1
