kind: pipeline
type: docker
name: default

volumes:
- name: git
  temp: {}

steps:
- name: Prepare repos
  image: regentmarkets/drone-git
  volumes:
  - name: git
    path: /home/git
  pull: if-not-exists
  settings:
    ssh_key:
      from_secret: ssh_key
  environment:
    CIRCLE_PROJECT_USERNAME: regentmarkets
    CIRCLE_PROJECT_REPONAME: bom-oauth
- name: Run tests
  image: regentmarkets/debian-ci:stable
  volumes:
  - name: git
    path: /home/git
  environment:
    OAUTH_CONFIG: /home/git/regentmarkets/bom-oauth/oauth.conf.example
  commands:
  - cp /home/git/.pg* /root
  - . /etc/profile.d/perl5.sh
  - start_services
  - cd /home/git/regentmarkets/bom-oauth && make test

---
kind: pipeline
type: docker
name: cover

volumes:
- name: git
  temp: {}

steps:
- name: Prepare repos
  image: regentmarkets/drone-git
  volumes:
  - name: git
    path: /home/git
  pull: if-not-exists
  settings:
    ssh_key:
      from_secret: ssh_key
  environment:
    CIRCLE_PROJECT_USERNAME: regentmarkets
    CIRCLE_PROJECT_REPONAME: bom-oauth
- name: Run tests
  image: regentmarkets/debian-ci:stable
  volumes:
  - name: git
    path: /home/git
  environment:
    OAUTH_CONFIG: /home/git/regentmarkets/bom-oauth/oauth.conf.example
  commands:
  - cp /home/git/.pg* /root
  - . /etc/profile.d/perl5.sh
  - start_services
  - cd /home/git/regentmarkets/bom-oauth && HARNESS_PERL_SWITCHES=-MDevel::Cover DEVEL_COVER_OPTIONS=-'ignore,^t/' /etc/rmg/bin/prove --timer -rl --norc -MBOM::Test t/BOM/
