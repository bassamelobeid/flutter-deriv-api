kind: pipeline
type: docker
name: default

volumes:
- name: git
  temp: {}

steps:
- name: Prepare repos
  image: regentmarkets/drone-git
  volumes:
  - name: git
    path: /home/git
  pull: if-not-exists
  settings:
    ssh_key:
      from_secret: ssh_key
  environment:
    CIRCLE_PROJECT_USERNAME: regentmarkets
    CIRCLE_PROJECT_REPONAME: bom-backoffice
- name: Run tests
  image: regentmarkets/debian-ci:stable
  volumes:
  - name: git
    path: /home/git
  commands:
  - cp /home/git/.pg* /root
  - . /etc/profile.d/perl5.sh
  - start_services
  - tee -a /etc/hosts < /home/git/regentmarkets/bom-postgres/hosts.db
  - cd /home/git/regentmarkets/bom-backoffice && make test

---
kind: pipeline
type: docker
name: syntax

volumes:
- name: git
  temp: {}

steps:
- name: Prepare repos
  image: regentmarkets/drone-git
  volumes:
  - name: git
    path: /home/git
  pull: if-not-exists
  settings:
    ssh_key:
      from_secret: ssh_key
  environment:
    CIRCLE_PROJECT_USERNAME: regentmarkets
    CIRCLE_PROJECT_REPONAME: bom-backoffice
- name: Run tests
  image: regentmarkets/debian-ci:stable
  volumes:
  - name: git
    path: /home/git
  commands:
  - cp /home/git/.pg* /root
  - . /etc/profile.d/perl5.sh
  - start_services
  - tee -a /etc/hosts < /home/git/regentmarkets/bom-postgres/hosts.db
  - mkdir -p /home/website/www/temp
  - cd /home/git/regentmarkets/bom-backoffice && make syntax
