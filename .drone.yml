kind: pipeline
type: docker
name: accounts

volumes:
- name: git
  temp: {}

steps:
- name: Prepare repos
  image: regentmarkets/drone-git
  volumes:
  - name: git
    path: /home/git
  pull: if-not-exists
  settings:
    ssh_key:
      from_secret: ssh_key
  environment:
    CIRCLE_PROJECT_USERNAME: regentmarkets
    CIRCLE_PROJECT_REPONAME: binary-websocket-api
- name: redis-v6
  image: redis:6
  detach: true
- name: Run tests
  image: regentmarkets/debian-ci:stable
  volumes:
  - name: git
    path: /home/git
  environment:
    RPC_CONFIG: /home/git/regentmarkets/bom-rpc/rpc.conf.travis
    WEBSOCKET_CONFIG: /home/git/regentmarkets/binary-websocket-api/websocket.conf.example
  commands:
  - cp /home/git/.pg* /root
  - . /etc/profile.d/perl5.sh
  - mkdir -p /var/lib/binary && chown nobody:nogroup /var/lib/binary
  - start_services
  - cd /home/git/regentmarkets/binary-websocket-api && make accounts

---
kind: pipeline
type: docker
name: p2p

volumes:
- name: git
  temp: {}

steps:
- name: Prepare repos
  image: regentmarkets/drone-git
  volumes:
  - name: git
    path: /home/git
  pull: if-not-exists
  settings:
    ssh_key:
      from_secret: ssh_key
  environment:
    CIRCLE_PROJECT_USERNAME: regentmarkets
    CIRCLE_PROJECT_REPONAME: binary-websocket-api
- name: redis-v6
  image: redis:6
  detach: true
- name: Run tests
  image: regentmarkets/debian-ci:stable
  volumes:
  - name: git
    path: /home/git
  environment:
    RPC_CONFIG: /home/git/regentmarkets/bom-rpc/rpc.conf.travis
    WEBSOCKET_CONFIG: /home/git/regentmarkets/binary-websocket-api/websocket.conf.example
  commands:
  - cp /home/git/.pg* /root
  - . /etc/profile.d/perl5.sh
  - mkdir -p /var/lib/binary && chown nobody:nogroup /var/lib/binary
  - start_services
  - cd /home/git/regentmarkets/bom-platform && perl bin/notify_pub.pl 2>&1 &
  - cd /home/git/regentmarkets/binary-websocket-api && make p2p

---
kind: pipeline
type: docker
name: pricing

volumes:
- name: git
  temp: {}

steps:
- name: Prepare repos
  image: regentmarkets/drone-git
  volumes:
  - name: git
    path: /home/git
  pull: if-not-exists
  settings:
    ssh_key:
      from_secret: ssh_key
  environment:
    CIRCLE_PROJECT_USERNAME: regentmarkets
    CIRCLE_PROJECT_REPONAME: binary-websocket-api
- name: redis-v6
  image: redis:6
  detach: true
- name: Run tests
  image: regentmarkets/debian-ci:stable
  volumes:
  - name: git
    path: /home/git
  environment:
    RPC_CONFIG: /home/git/regentmarkets/bom-rpc/rpc.conf.travis
    WEBSOCKET_CONFIG: /home/git/regentmarkets/binary-websocket-api/websocket.conf.example
  commands:
  - cp /home/git/.pg* /root
  - . /etc/profile.d/perl5.sh
  - mkdir -p /var/lib/binary && chown nobody:nogroup /var/lib/binary
  - start_services
  - cd /home/git/regentmarkets/bom-platform && perl bin/notify_pub.pl 2>&1 &
  - cd /home/git/regentmarkets/bom-pricing && perl -MBOM::Test bin/price_queue.pl &
  - cd /home/git/regentmarkets/bom-pricing && perl -MBOM::Test bin/price_daemon.pl --no-warmup=1 --workers=1 &
  - cd /home/git/regentmarkets/bom-transaction && perl bin/expiryd.pl -t 1 &
  - cd /home/git/regentmarkets/binary-websocket-api && make pricing

---
kind: pipeline
type: docker
name: misc

volumes:
- name: git
  temp: {}

steps:
- name: Prepare repos
  image: regentmarkets/drone-git
  volumes:
  - name: git
    path: /home/git
  pull: if-not-exists
  settings:
    ssh_key:
      from_secret: ssh_key
  environment:
    CIRCLE_PROJECT_USERNAME: regentmarkets
    CIRCLE_PROJECT_REPONAME: binary-websocket-api
- name: redis-v6
  image: redis:6
  detach: true
- name: Run tests
  image: regentmarkets/debian-ci:stable
  volumes:
  - name: git
    path: /home/git
  environment:
    RPC_CONFIG: /home/git/regentmarkets/bom-rpc/rpc.conf.travis
    WEBSOCKET_CONFIG: /home/git/regentmarkets/binary-websocket-api/websocket.conf.example
  commands:
  - cp /home/git/.pg* /root
  - . /etc/profile.d/perl5.sh
  - mkdir -p /var/lib/binary && chown nobody:nogroup /var/lib/binary
  - start_services
  - cd /home/git/regentmarkets/binary-websocket-api && make misc

---
kind: pipeline
type: docker
name: security

volumes:
- name: git
  temp: {}

steps:
- name: Prepare repos
  image: regentmarkets/drone-git
  volumes:
  - name: git
    path: /home/git
  pull: if-not-exists
  settings:
    ssh_key:
      from_secret: ssh_key
  environment:
    CIRCLE_PROJECT_USERNAME: regentmarkets
    CIRCLE_PROJECT_REPONAME: binary-websocket-api
- name: redis-v6
  image: redis:6
  detach: true
- name: Run tests
  image: regentmarkets/debian-ci:stable
  volumes:
  - name: git
    path: /home/git
  environment:
    RPC_CONFIG: /home/git/regentmarkets/bom-rpc/rpc.conf.travis
    WEBSOCKET_CONFIG: /home/git/regentmarkets/binary-websocket-api/websocket.conf.example
  commands:
  - cp /home/git/.pg* /root
  - . /etc/profile.d/perl5.sh
  - mkdir -p /var/lib/binary && chown nobody:nogroup /var/lib/binary
  - start_services
  - cd /home/git/regentmarkets/binary-websocket-api && make security

---
kind: pipeline
type: docker
name: schema

volumes:
- name: git
  temp: {}

steps:
- name: Prepare repos
  image: regentmarkets/drone-git
  volumes:
  - name: git
    path: /home/git
  pull: if-not-exists
  settings:
    ssh_key:
      from_secret: ssh_key
  environment:
    CIRCLE_PROJECT_USERNAME: regentmarkets
    CIRCLE_PROJECT_REPONAME: binary-websocket-api
- name: redis-v6
  image: redis:6
  detach: true
- name: Run tests
  image: regentmarkets/debian-ci:stable
  volumes:
  - name: git
    path: /home/git
  environment:
    RPC_CONFIG: /home/git/regentmarkets/bom-rpc/rpc.conf.travis
    WEBSOCKET_CONFIG: /home/git/regentmarkets/binary-websocket-api/websocket.conf.example
  commands:
  - cp /home/git/.pg* /root
  - . /etc/profile.d/perl5.sh
  - mkdir -p /var/lib/binary && chown nobody:nogroup /var/lib/binary
  - start_services
  - cd /home/git/regentmarkets/bom-platform && perl bin/notify_pub.pl 2>&1 &
  - cd /home/git/regentmarkets/binary-websocket-api && make schema


---
kind: pipeline
type: docker
name: structure

volumes:
- name: git
  temp: {}

steps:
- name: Prepare repos
  image: regentmarkets/drone-git
  volumes:
  - name: git
    path: /home/git
  pull: if-not-exists
  settings:
    ssh_key:
      from_secret: ssh_key
  environment:
    CIRCLE_PROJECT_USERNAME: regentmarkets
    CIRCLE_PROJECT_REPONAME: binary-websocket-api
- name: redis-v6
  image: redis:6
  detach: true
- name: Run tests
  image: regentmarkets/debian-ci:stable
  volumes:
  - name: git
    path: /home/git
  environment:
    RPC_CONFIG: /home/git/regentmarkets/bom-rpc/rpc.conf.travis
    WEBSOCKET_CONFIG: /home/git/regentmarkets/binary-websocket-api/websocket.conf.example
  commands:
  - cp /home/git/.pg* /root
  - . /etc/profile.d/perl5.sh
  - mkdir -p /var/lib/binary && chown nobody:nogroup /var/lib/binary
  - start_services
  - cd /home/git/regentmarkets/binary-websocket-api && make structure

---
kind: pipeline
type: docker
name: subscriptions

volumes:
- name: git
  temp: {}

steps:
- name: Prepare repos
  image: regentmarkets/drone-git
  volumes:
  - name: git
    path: /home/git
  pull: if-not-exists
  settings:
    ssh_key:
      from_secret: ssh_key
  environment:
    CIRCLE_PROJECT_USERNAME: regentmarkets
    CIRCLE_PROJECT_REPONAME: binary-websocket-api
- name: redis-v6
  image: redis:6
  detach: true
- name: Run tests
  image: regentmarkets/debian-ci:stable
  volumes:
  - name: git
    path: /home/git
  environment:
    RPC_CONFIG: /home/git/regentmarkets/bom-rpc/rpc.conf.travis
    WEBSOCKET_CONFIG: /home/git/regentmarkets/binary-websocket-api/websocket.conf.example
  commands:
  - cp /home/git/.pg* /root
  - . /etc/profile.d/perl5.sh
  - mkdir -p /var/lib/binary && chown nobody:nogroup /var/lib/binary
  - start_services
  - cd /home/git/regentmarkets/binary-websocket-api && make subscriptions

---
kind: pipeline
type: docker
name: backends

volumes:
- name: git
  temp: {}

steps:
- name: Prepare repos
  image: regentmarkets/drone-git
  volumes:
  - name: git
    path: /home/git
  pull: if-not-exists
  settings:
    ssh_key:
      from_secret: ssh_key
  environment:
    CIRCLE_PROJECT_USERNAME: regentmarkets
    CIRCLE_PROJECT_REPONAME: binary-websocket-api
- name: redis-v6
  image: redis:6
  detach: true
- name: Run tests
  image: regentmarkets/debian-ci:stable
  volumes:
  - name: git
    path: /home/git
  environment:
    RPC_CONFIG: /home/git/regentmarkets/bom-rpc/rpc.conf.travis
    WEBSOCKET_CONFIG: /home/git/regentmarkets/binary-websocket-api/websocket.conf.example
  commands:
  - cp /home/git/.pg* /root
  - . /etc/profile.d/perl5.sh
  - mkdir -p /var/lib/binary && chown nobody:nogroup /var/lib/binary
  - start_services
  - cd /home/git/regentmarkets/binary-websocket-api && make backends

---
kind: pipeline
type: docker
name: unit

volumes:
- name: git
  temp: {}

steps:
- name: Prepare repos
  image: regentmarkets/drone-git
  volumes:
  - name: git
    path: /home/git
  pull: if-not-exists
  settings:
    ssh_key:
      from_secret: ssh_key
  environment:
    CIRCLE_PROJECT_USERNAME: regentmarkets
    CIRCLE_PROJECT_REPONAME: binary-websocket-api
- name: Run tests
  image: regentmarkets/debian-ci:stable
  volumes:
  - name: git
    path: /home/git
  environment:
    RPC_CONFIG: /home/git/regentmarkets/bom-rpc/rpc.conf.travis
    WEBSOCKET_CONFIG: /home/git/regentmarkets/binary-websocket-api/websocket.conf.example
  commands:
  - cp /home/git/.pg* /root
  - . /etc/profile.d/perl5.sh
  - mkdir -p /var/lib/binary && chown nobody:nogroup /var/lib/binary
  - cd /home/git/regentmarkets/binary-websocket-api && make unit

---
kind: pipeline
type: docker
name: code_coverage

volumes:
- name: git
  temp: {}

steps:
- name: Prepare repos
  image: regentmarkets/drone-git
  volumes:
  - name: git
    path: /home/git
  pull: if-not-exists
  settings:
    ssh_key:
      from_secret: ssh_key
  environment:
    CIRCLE_PROJECT_USERNAME: regentmarkets
    CIRCLE_PROJECT_REPONAME: binary-websocket-api
- name: redis-v6
  image: redis:6
  detach: true
- name: Run tests
  image: regentmarkets/debian-ci:stable
  volumes:
  - name: git
    path: /home/git
  environment:
    RPC_CONFIG: /home/git/regentmarkets/bom-rpc/rpc.conf.travis
    WEBSOCKET_CONFIG: /home/git/regentmarkets/binary-websocket-api/websocket.conf.example
  commands:
  - cp /home/git/.pg* /root
  - . /etc/profile.d/perl5.sh
  - mkdir -p /var/lib/binary && chown nobody:nogroup /var/lib/binary
  - start_services
  - cd /home/git/regentmarkets/bom-platform && perl bin/notify_pub.pl 2>&1 &
  - cd /home/git/regentmarkets/bom-pricing && perl -MBOM::Test bin/price_queue.pl &
  - cd /home/git/regentmarkets/bom-pricing && perl -MBOM::Test bin/price_daemon.pl --no-warmup=1 --workers=1 &
  - cd /home/git/regentmarkets/bom-transaction && perl bin/expiryd.pl -t 1 &
  - cd /home/git/regentmarkets/binary-websocket-api && make cover_websocket_tests sub_test=schema_suite
