package BOM::RiskReporting::Client;

=head1 NAME

BOM::RiskReporting::Client

=head1 DESCRIPTION

Generates a client risk report

=cut

use strict;
use warnings;
use Moose;
extends 'BOM::RiskReporting::Base';

use Excel::Writer::XLSX;
use File::Temp qw(tmpnam);

has client => (
    is => 'rw',
);

has workbook => (
    is => 'rw',
    lazy_build => 1,
);

sub _build_workbook {
    my $self = shift;
    return Excel::Writer::XLSX->new($self->_workbook_file);
}

has _workbook_file => (
    is => 'rw',
    default => sub {return tmpnam() . '.xlsx'}
);


sub _client_details {
    my $self = shift;

    my $worksheet = $self->workbook->add_worksheet('client details');

    my $count = 0;
    for my $key (BOM::Database::AutoGenerated::Rose::Client->meta->column_names) {
        next if $key =~ /(client_password|secret_answer)/;
        $count++;
        $worksheet->write( "A$count", $key );
        $worksheet->write( "B$count", $self->client->$key );
    }

    return;
}

sub _documents_on_file {
    my $self = shift;

    my $worksheet = $self->workbook->add_worksheet('documents on file');

    my $today = Date::Utility->today;
    my @docs  = $self->client->client_authentication_document or return;
    my $count = 0;
    for my $doc (@docs) {
        $count++;
        $worksheet->write( "$count", 0, $doc->document_type || '' );
        $worksheet->write( "$count", 1, $doc->document_format || '' );
        $worksheet->write( "$count", 2, $doc->document_path || '' );
        $worksheet->write( "$count", 3, $doc->expiration_date || 'none' );
        $worksheet->write( "$count", 4, $doc->comments || 'none' );
    }

    return;
}

sub generate {
    my $self = shift;

    $self->db_broker_code($self->client->broker);

    $self->_client_details;
    $self->_documents_on_file;
    # $self->_total_deposits_withdrawals;
    # $self->_change_of_IP;
    # $self->_change_of_status;
    # $self->_review_of_trades_bets;
    # $self->_comments;

    $self->workbook->close;
    return $self->_workbook_file;
}

no Moose;
__PACKAGE__->meta->make_immutable;
1;
