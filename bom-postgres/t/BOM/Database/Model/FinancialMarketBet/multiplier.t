#!/etc/rmg/bin/perl

use strict;
use warnings;
use Test::More;
use Test::Warnings;
use Test::Exception;
use Date::Utility;

use Format::Util::Numbers qw/financialrounding/;

use BOM::Database::AutoGenerated::Rose::FinancialMarketBetOpen::Manager;
use BOM::Database::Model::Account;
use BOM::Database::Model::FinancialMarketBet::Multiplier;
use BOM::Database::Helper::FinancialMarketBet;
use BOM::Test::Data::Utility::UnitTestDatabase qw(:init);
use Date::Utility;

my $connection_builder;
my $account;

lives_ok {
    $connection_builder = BOM::Database::ClientDB->new({
        broker_code => 'CR',
    });

    my $client = BOM::Test::Data::Utility::UnitTestDatabase::create_client({
        broker_code => 'CR',
    });
    $account = $client->set_default_account('USD');

    $client->payment_free_gift(
        currency => 'USD',
        amount   => 500,
        remark   => 'free gift',
    );

}
'create & credit acc';
my %account_data = (
    account_data => {
        client_loginid => $account->client_loginid,
        currency_code  => $account->currency_code
    });

my $multiplier_bet;
my $multiplier_fmb_id;

my $underlying_symbol = 'R_100';
my $payout_price      = 0;
my $buy_price         = 100;
my $sell_price        = 0;
my $remark            = 'Test Remark';
my $start_time        = Date::Utility->new('2010-12-02 12:00:00');
my $expiry_time       = Date::Utility->new('2010-12-02 14:00:00');
my $is_expired        = 1;
my $bet_class         = 'multiplier';
my $bet_type          = 'MULTUP';
my $short_code        = 'MULTUP_R_100_100_10_' . $start_time->epoch . '_' . $expiry_time->epoch;

my $basis_spot            = 100;
my $multiplier            = 10;
my $stop_out_order_amount = -100;
my $stop_out_order_date   = $start_time;

lives_ok {

    $multiplier_bet = BOM::Database::Model::FinancialMarketBet::Multiplier->new({
            'data_object_params' => {
                'account_id' => $account->id,

                'underlying_symbol' => $underlying_symbol,
                'payout_price'      => $payout_price,
                'buy_price'         => $buy_price,
                'remark'            => $remark,
                'purchase_time'     => $start_time->datetime_yyyymmdd_hhmmss,
                'start_time'        => $start_time->datetime_yyyymmdd_hhmmss,
                'expiry_time'       => $expiry_time->datetime_yyyymmdd_hhmmss,
                'is_expired'        => $is_expired,
                'bet_class'         => $bet_class,
                'bet_type'          => $bet_type,
                'short_code'        => $short_code,

                'basis_spot'            => $basis_spot,
                'multiplier'            => $multiplier,
                'stop_out_order_amount' => $stop_out_order_amount,
                'stop_out_order_date'   => $stop_out_order_date->datetime_yyyymmdd_hhmmss,
            },
        },
    );

    my $financial_market_bet_helper = BOM::Database::Helper::FinancialMarketBet->new({
        %account_data,
        bet => $multiplier_bet,
        db  => $connection_builder->db,
    });
    $financial_market_bet_helper->bet_data->{quantity} = 1;
    $financial_market_bet_helper->buy_bet;

    $multiplier_fmb_id = $multiplier_bet->financial_market_bet_open_record->id;
}
'expect to be able to buy the bet';

isa_ok($multiplier_bet->class_orm_record, 'BOM::Database::AutoGenerated::Rose::Multiplier');

# Check if it can be initialized propery by sendin the parent orm object that has the run_bet table joined
my $fmb_records = BOM::Database::AutoGenerated::Rose::FinancialMarketBetOpen::Manager->get_financial_market_bet_open(
    require_objects => ['multiplier'],
    query           => [
        id => [$multiplier_fmb_id],
    ],
    db => $connection_builder->db,
);

my $multiplier_by_orm_object = BOM::Database::Model::FinancialMarketBet::Multiplier->new({
    'financial_market_bet_open_record' => $fmb_records->[0],
    'db'                               => $connection_builder->db
});
cmp_ok($multiplier_by_orm_object->multiplier_record->basis_spot, '==', $basis_spot, 'Check the child params to see if they are laoded properly');
cmp_ok($multiplier_by_orm_object->multiplier_record->multiplier, '==', $multiplier, 'Check prediction to see if the object was loaded properly');
cmp_ok($multiplier_by_orm_object->financial_market_bet_open_record->payout_price,
    '==', $payout_price, 'Check the parent parent to see if they are loaded properly');

lives_ok {
    $multiplier_bet = BOM::Database::Model::FinancialMarketBet::Multiplier->new({
            data_object_params => {
                'financial_market_bet_id' => $multiplier_fmb_id,
            },
            db => $connection_builder->db,
        },
    );
    $multiplier_bet->load;

}
'expect to load the bet records after saving them';

lives_ok {
    $multiplier_bet = BOM::Database::Model::FinancialMarketBet::Multiplier->new({
            'data_object_params' => {
                'financial_market_bet_id' => $multiplier_fmb_id,
            },
            db => $connection_builder->db,
        },
    );
    $multiplier_bet->load;
    $multiplier_bet->sell_price(40);

    my $financial_market_bet_helper = BOM::Database::Helper::FinancialMarketBet->new({
            %account_data,
            bet      => $multiplier_bet,
            bet_data => {
                is_expired => $is_expired,
                sell_time  => Date::Utility::today()->db_timestamp,
            },
            db => $connection_builder->db,
        });
    $financial_market_bet_helper->bet_data->{quantity} = 1;
    $financial_market_bet_helper->sell_bet // die "Bet not sold";
    $sell_price = 40;
}
'expect to sell';

is($multiplier_bet->financial_market_bet_open_record->account_id,        $account->id,       'account_id');
is($multiplier_bet->financial_market_bet_open_record->underlying_symbol, $underlying_symbol, 'underlying_symbol');
cmp_ok($multiplier_bet->financial_market_bet_open_record->payout_price, '==', financialrounding('amount', 'USD', $payout_price), 'payout_price');
cmp_ok($multiplier_bet->financial_market_bet_open_record->buy_price,    '==', financialrounding('amount', 'USD', $buy_price),    'buy_price');
cmp_ok($multiplier_bet->financial_market_bet_open_record->sell_price,   '==', financialrounding('amount', 'USD', $sell_price),   'sell_price');
is($multiplier_bet->financial_market_bet_open_record->expiry_time->epoch, $expiry_time->epoch, 'expiry_time');
is($multiplier_bet->financial_market_bet_open_record->is_expired,         $is_expired,         'is_expired');
is($multiplier_bet->financial_market_bet_open_record->is_sold,            1,                   'is_sold');
is($multiplier_bet->financial_market_bet_open_record->bet_class,          $bet_class,          'bet_class');
is($multiplier_bet->financial_market_bet_open_record->bet_type,           $bet_type,           'bet_type');
is($multiplier_bet->financial_market_bet_open_record->short_code,         $short_code,         'short_code');

is($multiplier_bet->multiplier_record->basis_spot,            $basis_spot,            'basis_spot');
is($multiplier_bet->multiplier_record->multiplier,            $multiplier,            'multiplier');
is($multiplier_bet->multiplier_record->stop_out_order_amount, $stop_out_order_amount, 'stop_out_order_amount');
is(
    $multiplier_bet->multiplier_record->stop_out_order_date,
    $stop_out_order_date->date_yyyymmdd . 'T' . $stop_out_order_date->time_hhmmss,
    'stop_out_order_date'
);

done_testing();
